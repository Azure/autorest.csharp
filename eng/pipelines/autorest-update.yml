pr:
  branches:
    include:
    - feature/*

variables:
  nugetMultiFeedWarnLevel: 'none'

resources:
  repositories:
    - repository: azure-sdk-tools
      type: github
      name: Azure/azure-sdk-tools
      endpoint: azure
      ref: refs/tags/azure-sdk-tools_20230428.1

jobs:
  - job: "Regen_and_Push"
    timeoutInMinutes: 30
    pool:
      name: azsdk-pool-mms-win-2022-general
      vmImage: windows-2022
    steps:
      - script: echo $(Build.Repository.Name)
      - script: echo $(Build.Repository.Uri)
      - script: echo $(Build.SourceBranch)
      - script: echo $(Build.SourceBranchName)
      - checkout: self
        fetchDepth: 1
      - checkout: azure-sdk-tools
        fetchDepth: 1
      - task: UseDotNet@2
        displayName: 'Use .NET Core SDK'
        retryCountOnTaskFailure: 3
        inputs:
          useGlobalJson: true
          performMultiLevelLookup: true
      - task: NodeTool@0
        displayName: "Install Node 18.x"
        inputs:
          versionSpec: '18.x'
      - script: |
          npm ci
        displayName: "Install packages"
        workingDirectory: $(Build.SourcesDirectory)/autorest.csharp
      - pwsh: ./eng/Generate.ps1 Authoring-TypeSpec
        displayName: "Generate Codes"
        workingDirectory: $(Build.SourcesDirectory)/autorest.csharp
      - pwsh: ./eng/ParsePRInfo.ps1 -SourceBranch $(System.PullRequest.SourceBranch) -SourceRepositoryURI $(System.PullRequest.SourceRepositoryURI)
        name: PRUrl
        displayName: "Build PR Url"
        workingDirectory: $(Build.SourcesDirectory)/autorest.csharp
      # - template: /eng/common/pipelines/templates/steps/git-push-changes.yml@azure-sdk-tools
      #   parameters:
      #     BaseRepoBranch: $(System.PullRequest.SourceBranch)
      #     BaseRepoOwner: azure-sdk
      #     CommitMsg: Update SDK codes ${{ parameters.filter }}
      #     TargetRepoOwner: Azure
      #     TargetRepoName: autorest.csharp
      #     WorkingDirectory: $(Build.SourcesDirectory)/autorest.csharp
      #     ScriptDirectory: $(Build.SourcesDirectory)/azure-sdk-tools/eng/common/scripts