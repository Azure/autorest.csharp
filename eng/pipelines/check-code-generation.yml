# Generate projects of smoke tests, projects under `samples` and `test` folders.
# Also check if projects under `samples` and `test` folders are updated.

parameters:
  - name: name
    type: string
  - name: filter
    type: string
  - name: usePackageJsonFromArtifacts
    type: boolean
    default: false
  - name: dependsOn
    type: object
    default: []

jobs:
- job: ${{ parameters.name }}
  pool:
    name: azsdk-pool-mms-win-2022-general
    vmImage: windows-2022
  dependsOn: ${{ parameters.dependsOn }}
  steps:
    - task: NodeTool@0
      displayName: "Install Node 18.x"
      inputs:
        versionSpec: '18.x'
    - task: UseDotNet@2
      displayName: 'Use .NET Core SDK'
      inputs:
        useGlobalJson: true
        performMultiLevelLookup: true
    - ${{ if eq(parameters.usePackageJsonFromArtifacts, 'true') }}:
      - task: DownloadPipelineArtifact@2
        displayName: 'Download package-json artifact'
        inputs: 
          buildType: current
          artifact: package-json
          targetPath: $(Build.SourcesDirectory)
      - pwsh: |
          Move-Item ./emitter-package.json ./src/TypeSpec.Extension/Emitter.Csharp/package.json -Force
          git add './package.json' './package-lock.json' './src/TypeSpec.Extension/Emitter.Csharp/package.json'
        displayName: 'Replace Emitter.Csharp/package.json'
        workingDirectory: $(Build.SourcesDirectory)
    - script: |
        npm ci
        npm ls -a
      displayName: "Install and list packages"
      workingDirectory: $(Build.SourcesDirectory)/autorest.csharp
    - script: |
        npm ls -a
      displayName: "List packages"
      workingDirectory: $(Build.SourcesDirectory)/autorest.csharp
    - pwsh: .\eng\CodeGenerationCheck.ps1 -Filter "${{ parameters.filter }}"
      displayName: "Check if generated code is up-to-date"
      env:
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
        DOTNET_CLI_TELEMETRY_OPTOUT: 1
        DOTNET_MULTILEVEL_LOOKUP: 0
